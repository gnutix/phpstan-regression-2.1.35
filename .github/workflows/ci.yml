name: PHPStan Regression Test

on:
  push:
    branches: [master, main]
  pull_request:
  workflow_dispatch:

jobs:
  test:
    name: PHPStan ${{ matrix.phpstan }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        phpstan:
          - '2.1.33'
          - '2.1.34'
          - '2.1.35'
          - '2.1.x-dev'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Install dependencies
        run: composer require --dev phpstan/phpstan:${{ matrix.phpstan }} --no-interaction --no-progress

      - name: Show PHPStan version
        run: vendor/bin/phpstan --version

      - name: Run PHPStan
        id: phpstan
        run: |
          set +e
          OUTPUT=$(vendor/bin/phpstan analyse --no-progress --error-format=table 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Count errors
          if echo "$OUTPUT" | grep -q "No errors"; then
            echo "errors=0" >> $GITHUB_OUTPUT
          else
            ERRORS=$(echo "$OUTPUT" | grep -oP '\[ERROR\] Found \K\d+' || echo "0")
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          fi

          # For 2.1.33 and 2.1.34, we expect NO errors (exit 0)
          # For 2.1.35 and 2.1.x-dev, we expect errors (regression)
          if [[ "${{ matrix.phpstan }}" == "2.1.33" || "${{ matrix.phpstan }}" == "2.1.34" ]]; then
            if [[ $EXIT_CODE -ne 0 ]]; then
              echo "::error::Expected NO errors on PHPStan ${{ matrix.phpstan }}, but got errors!"
              exit 1
            fi
          else
            if [[ $EXIT_CODE -eq 0 ]]; then
              echo "::notice::Regression fixed! PHPStan ${{ matrix.phpstan }} now passes."
            fi
          fi
          exit 0

      - name: Summary
        run: |
          echo "## PHPStan ${{ matrix.phpstan }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.phpstan.outputs.errors }}" == "0" ]]; then
            echo "✅ **No errors**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **${{ steps.phpstan.outputs.errors }} errors** (regression)" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Results Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Summary Table
        run: |
          echo "## PHPStan Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Version | Expected | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 2.1.33 | ✅ Pass | See job |" >> $GITHUB_STEP_SUMMARY
          echo "| 2.1.34 | ✅ Pass | See job |" >> $GITHUB_STEP_SUMMARY
          echo "| 2.1.35 | ❌ Fail (regression) | See job |" >> $GITHUB_STEP_SUMMARY
          echo "| 2.1.x-dev | ❌ Fail (regression) | See job |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issue" >> $GITHUB_STEP_SUMMARY
          echo "Closure parameter types are not inferred from expected Closure signature in 2.1.35+." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See https://github.com/phpstan/phpstan/issues/13993" >> $GITHUB_STEP_SUMMARY
